{% extends "base.html" %}
{% block title %}{{ session.label }} — Sala de Triagem{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="{{ url_for('dashboard.index') }}" class="text-decoration-none text-muted small">← Voltar</a>
    <h4 class="mb-0 mt-1">{{ session.label }}</h4>
    <span class="small text-muted">
      Expira: {{ session.expires_at|datefmt }} |
      {% if session.is_active and not session.is_expired %}
        <span class="badge bg-success">Ativo</span>
      {% else %}
        <span class="badge bg-secondary">Encerrado</span>
      {% endif %}
    </span>
  </div>
  <div class="d-flex gap-2">
    {% if session.is_active %}
    <form action="{{ url_for('dashboard.purge_session', session_id=session.id) }}" method="post" class="d-inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-outline-warning btn-sm" onclick="return confirm('Apagar todos os dados sensíveis?')">
        <i class="bi bi-trash"></i> Purgar Dados
      </button>
    </form>
    <form action="{{ url_for('dashboard.close_session', session_id=session.id) }}" method="post" class="d-inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button class="btn btn-danger btn-sm" onclick="return confirm('Encerrar plantão e apagar dados?')">
        <i class="bi bi-stop-circle"></i> Encerrar Plantão
      </button>
    </form>
    {% endif %}
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Link para Convidado</div>
      <div class="card-body">
        {% if link and session.is_active %}
          <p class="small">Compartilhe este link ou QR code com o convidado:</p>
          <div class="input-group mb-2">
            <input type="text" class="form-control form-control-sm" value="{{ intake_url }}" id="intakeUrl" readonly>
            <button class="btn btn-outline-secondary btn-sm" onclick="copyUrl()">Copiar</button>
            <button class="btn btn-outline-success btn-sm" onclick="window.open('https://wa.me/?text=' + encodeURIComponent(document.getElementById('intakeUrl').value), '_blank')">Compartilhar</button>
          </div>
          {% if qr_svg %}
          <div class="text-center mt-2">
            {{ qr_svg|safe }}
          </div>
          <div class="text-center mt-2">
            <a href="{{ url_for('dashboard.print_qr', session_id=session.id) }}" target="_blank" class="btn btn-outline-secondary btn-sm">Imprimir QR</a>
          </div>
          {% endif %}
        {% else %}
          <p class="text-muted small">Plantão inativo ou sem link.</p>
          {% if session.is_active %}
          <form action="{{ url_for('dashboard.new_link', session_id=session.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-primary btn-sm">Gerar Novo Link</button>
          </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Resumo</div>
      <div class="card-body">
        <p class="mb-1 small"><strong>Submissions pendentes:</strong> <span id="pending-count">{{ submissions|length }}</span></p>
        <p class="mb-1 small"><strong>Registros fechados:</strong> {{ logs|length }}</p>
        {% if session.is_active %}
        <button class="btn btn-outline-primary btn-sm mt-2" onclick="refreshSubmissions()">
          <i class="bi bi-arrow-clockwise"></i> Atualizar
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Submissions -->
<h5>Triagens Pendentes</h5>
<div id="submissions-container">
  {% for sub in submissions %}
  <div class="card mb-2" id="sub-{{ sub.submission_id }}">
    <div class="card-body py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ sub.guest_name }}</strong>
          <span class="badge bg-info text-dark ms-2">{{ sub.crime_type }}</span>
          <span class="text-muted small ms-2">{{ sub.received_at|datefmt('dd/mm HH:MM') }}</span>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Ações
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" onclick="loadDetail('{{ session.id }}', '{{ sub.submission_id }}'); return false;">
                <i class="bi bi-eye"></i> Ver detalhes
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-success" href="#" onclick="closeSubmission('{{ session.id }}', '{{ sub.submission_id }}'); return false;">
                <i class="bi bi-check-circle"></i> Concluir
              </a>
            </li>
            <li>
              <a class="dropdown-item text-danger" href="#" onclick="discardSubmission('{{ session.id }}', '{{ sub.submission_id }}'); return false;">
                <i class="bi bi-x-circle"></i> Descartar
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card-footer bg-white p-0 d-none" id="sub-detail-{{ sub.submission_id }}">
    </div>
  </div>
  {% else %}
  <p class="text-muted" id="no-submissions">Nenhuma triagem pendente.</p>
  {% endfor %}
</div>

{% if logs %}
<h5 class="mt-4">Registros Finalizados</h5>
<table class="table table-sm table-striped">
  <thead><tr><th>Nome</th><th>Tipo</th><th>Recebido</th><th>Encerrado</th><th>Status</th></tr></thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td>{{ log.guest_display_name or '—' }}</td>
      <td>{{ log.crime_type or '—' }}</td>
      <td>{{ log.received_at|datefmt('dd/mm HH:MM') if log.received_at else '—' }}</td>
      <td>{{ log.closed_at|datefmt('dd/mm HH:MM') if log.closed_at else '—' }}</td>
      <td>
        {% if log.status == 'closed' %}<span class="badge bg-success">Fechado</span>
        {% elif log.status == 'discarded' %}<span class="badge bg-warning text-dark">Descartado</span>
        {% else %}<span class="badge bg-info">Recebido</span>{% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% endblock %}
{% block scripts %}
<script>
const CSRF_TOKEN = "{{ csrf_token() }}";

function copyUrl() {
  const input = document.getElementById('intakeUrl');
  navigator.clipboard.writeText(input.value);
}

function loadDetail(sessionId, subId) {
  const container = document.getElementById(`sub-detail-${subId}`);
  container.classList.remove('d-none');
  container.innerHTML = '<div class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>';
  fetch(`/api/sessions/${sessionId}/submissions/${subId}`)
    .then(r => r.json())
    .then(data => {
      let html = '<div class="p-3"><div class="row">';
      html += '<div class="col-md-6">';
      html += '<h6>Dados Pessoais</h6>';
      html += '<table class="table table-sm">';
      if (data.dob) html += `<tr><td>Nascimento</td><td>${data.dob}</td></tr>`;
      if (data.rg) html += `<tr><td>RG</td><td>${data.rg}</td></tr>`;
      if (data.cpf) html += `<tr><td>CPF</td><td>${data.cpf}</td></tr>`;
      if (data.address) html += `<tr><td>Endereço</td><td>${data.address}</td></tr>`;
      html += '</table>';
      if (data.structured && data.structured.length > 0) {
        html += '<h6>Respostas</h6><table class="table table-sm">';
        data.structured.forEach(([label, val]) => {
          html += `<tr><td>${label}</td><td>${val}</td></tr>`;
        });
        html += '</table>';
      }
      if (data.narrative) {
        html += `<h6>Relato</h6><p class="small">${data.narrative}</p>`;
      }
      html += '</div>';
      html += '<div class="col-md-6">';
      html += '<h6>Texto para Cópia</h6>';
      html += `<textarea class="form-control font-monospace small" rows="12" id="text-${subId}" readonly>${data.text}</textarea>`;
      html += `<button class="btn btn-outline-primary btn-sm mt-2" onclick="copyText('${subId}')"><i class="bi bi-clipboard"></i> Copiar Texto</button>`;
      if (data.photo_count > 0) {
        html += `<h6 class="mt-3">Fotos (${data.photo_count})</h6><div class="d-flex gap-2 flex-wrap">`;
        for (let i = 0; i < data.photo_count; i++) {
          html += `<img src="/api/sessions/${sessionId}/submissions/${subId}/photo/${i}" class="img-thumbnail" style="max-height:120px;">`;
        }
        html += '</div>';
      }
      html += '</div></div></div>';
      container.innerHTML = html;
    });
}

function copyText(subId) {
  const ta = document.getElementById(`text-${subId}`);
  navigator.clipboard.writeText(ta.value);
}

function closeSubmission(sessionId, subId) {
  if (!confirm('Concluir triagem e apagar dados sensíveis?')) return;
  fetch(`/api/sessions/${sessionId}/submissions/${subId}/close`, {
    method: 'POST',
    headers: {'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json'},
  }).then(r => r.json()).then(d => {
    if (d.status === 'ok') document.getElementById(`sub-${subId}`).remove();
  });
}

function discardSubmission(sessionId, subId) {
  if (!confirm('Descartar e apagar dados?')) return;
  fetch(`/api/sessions/${sessionId}/submissions/${subId}/discard`, {
    method: 'POST',
    headers: {'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json'},
  }).then(r => r.json()).then(d => {
    if (d.status === 'ok') document.getElementById(`sub-${subId}`).remove();
  });
}

function refreshSubmissions() {
  const sessionId = {{ session.id | tojson }};
  fetch(`/api/sessions/${sessionId}/submissions`)
    .then(r => r.json())
    .then(subs => {
      document.getElementById('pending-count').textContent = subs.length;
    });
}

{% if session.is_active %}
setInterval(refreshSubmissions, 30000);
{% endif %}
</script>
{% endblock %}
